name: Release

on:
  push:
    branches:
      - main

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          extra_plugins: |
            @semantic-release/commit-analyzer
            @semantic-release/release-notes-generator
            @semantic-release/github
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-binaries:
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    name: Build & Upload to Release ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, windows-latest, macos-latest]
    permissions:
      contents: write
    env:
      ASSET_PATH: ""
      ASSET_PATH_INSTALLER: ""
      ASSET_PATH_PORTABLE: ""

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.2.4'

    - name: Install Linux Dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libdbus-1-dev build-essential libgl1-mesa-dev

    - name: Configure CMake
      run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Package AppImage (Linux)
      if: runner.os == 'Linux'
      run: |
        wget -c https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
        chmod +x linuxdeployqt-continuous-x86_64.AppImage
        mkdir -p AppDir/usr/bin
        cp build/joymanager AppDir/usr/bin/
        cp joymanager.desktop AppDir/
        cp joymanager.png AppDir/
        unset QTDIR; unset QT_PLUGIN_PATH; unset LD_LIBRARY_PATH
        ./linuxdeployqt-continuous-x86_64.AppImage AppDir/joymanager.desktop -appimage
        mv JoyManager-*.AppImage joymanager.AppImage

    - name: Package macOS
      if: runner.os == 'macOS'
      run: |
        macdeployqt build/joymanager.app -dmg -always-overwrite

    - name: Package Windows
      if: runner.os == 'Windows'
      shell: bash
      run: |
        if [ -f "build/Release/joymanager.exe" ]; then
          WIN_EXE="build/Release/joymanager.exe"
        else
          WIN_EXE="build/joymanager.exe"
        fi
        windeployqt --release "$WIN_EXE"

    - name: Prepare Assets
      shell: bash
      run: |
        if [ "${{ runner.os }}" == "Linux" ]; then
          echo "ASSET_PATH=joymanager.AppImage" >> $GITHUB_ENV
        elif [ "${{ runner.os }}" == "Windows" ]; then
          if [ -d "build/Release" ]; then
            BUILD_DIR="build/Release"
          else
            BUILD_DIR="build"
          fi
          
          # Create Installer
          # Pass version if available (needs semantic release version)
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0"; fi
          export MSYS_NO_PATHCONV=1
          "C:/Program Files (x86)/Inno Setup 6/ISCC.exe" /DMyAppVersion="$VERSION" /DMyBuildDir="$BUILD_DIR" installer.iss
          unset MSYS_NO_PATHCONV
          
          cd $BUILD_DIR
          7z a -sfx ../../JoyManager-Portable.exe joymanager.exe *.dll platforms/ styles/ iconengines/ imageformats/
          cd ../..
          
          echo "ASSET_PATH_INSTALLER=JoyManager-Setup.exe" >> $GITHUB_ENV
          echo "ASSET_PATH_PORTABLE=JoyManager-Portable.exe" >> $GITHUB_ENV
        elif [ "${{ runner.os }}" == "macOS" ]; then
          mv build/joymanager.dmg joymanager.dmg
          echo "ASSET_PATH=joymanager.dmg" >> $GITHUB_ENV
        fi

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.release.outputs.new_release_version }}
        files: |
          ${{ env.ASSET_PATH }}
          ${{ env.ASSET_PATH_INSTALLER }}
          ${{ env.ASSET_PATH_PORTABLE }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
