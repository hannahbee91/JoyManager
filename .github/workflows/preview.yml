name: PR Preview

on:
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, windows-latest, macos-latest]
    env:
      ASSET_PATH: ""
      ASSET_PATH_INSTALLER: ""
      ASSET_PATH_PORTABLE: ""

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.2.4'

    - name: Install Linux Dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libdbus-1-dev build-essential libgl1-mesa-dev

    - name: Configure CMake
      run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Package AppImage (Linux)
      if: runner.os == 'Linux'
      run: |
        wget -c https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
        chmod +x linuxdeployqt-continuous-x86_64.AppImage
        # Create AppDir structure
        mkdir -p AppDir/usr/bin
        cp build/joymanager AppDir/usr/bin/
        cp joymanager.desktop AppDir/
        cp joymanager.png AppDir/
        # Run linuxdeployqt
        unset QTDIR; unset QT_PLUGIN_PATH; unset LD_LIBRARY_PATH
        ./linuxdeployqt-continuous-x86_64.AppImage AppDir/joymanager.desktop -appimage
        mv JoyManager-*.AppImage joymanager.AppImage

    - name: Package macOS
      if: runner.os == 'macOS'
      run: |
        macdeployqt build/joymanager.app -dmg -always-overwrite

    - name: Package Windows
      if: runner.os == 'Windows'
      shell: bash
      run: |
        if [ -f "build/Release/joymanager.exe" ]; then
          WIN_EXE="build/Release/joymanager.exe"
        else
          WIN_EXE="build/joymanager.exe"
        fi
        windeployqt --release "$WIN_EXE"

    - name: Prepare Assets
      shell: bash
      run: |
        if [ "${{ runner.os }}" == "Linux" ]; then
          echo "ASSET_PATH=joymanager.AppImage" >> $GITHUB_ENV
        elif [ "${{ runner.os }}" == "Windows" ]; then
          if [ -d "build/Release" ]; then
            BUILD_DIR="build/Release"
          else
            BUILD_DIR="build"
          fi
          
          # Create Installer
          export MSYS_NO_PATHCONV=1
          "C:/Program Files (x86)/Inno Setup 6/ISCC.exe" /DMyAppVersion="0.0.0-preview" /DMyBuildDir="$BUILD_DIR" installer.iss
          unset MSYS_NO_PATHCONV
          
          # Create Portable SFX
          cd $BUILD_DIR
          7z a -sfx ../../JoyManager-Portable.exe joymanager.exe *.dll platforms/ styles/ iconengines/ imageformats/
          cd ../..
          
          echo "ASSET_PATH_INSTALLER=JoyManager-Setup.exe" >> $GITHUB_ENV
          echo "ASSET_PATH_PORTABLE=JoyManager-Portable.exe" >> $GITHUB_ENV
        elif [ "${{ runner.os }}" == "macOS" ]; then
          mv build/joymanager.dmg joymanager.dmg
          echo "ASSET_PATH=joymanager.dmg" >> $GITHUB_ENV
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: joymanager-${{ matrix.os }}
        path: |
          ${{ env.ASSET_PATH }}
          ${{ env.ASSET_PATH_INSTALLER }}
          ${{ env.ASSET_PATH_PORTABLE }}
